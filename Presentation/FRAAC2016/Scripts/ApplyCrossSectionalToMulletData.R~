# CREATED  22 May 2015

# PURPOSE reproduce the method (cross sectional analysis) applied by LTMP to estimate total mortality from mullet age data

# Load data estimated number at age in the catch
tmp.data <- read.csv("../Data/MulletNumberAtAgeHarvestedForMarco2007-2014.csv")
catch.at.age <- with(tmp.data, tapply(Numbers.Harvested, list(Year, Age.Group), I))
catch.at.age <- replace(catch.at.age, is.na(catch.at.age), 0)

# Plot
library(ggplot2)
p1 <- ggplot(tmp.data, aes(Age.Group, log(Numbers.Harvested))) + geom_point() + facet_wrap(~Year, nrow = 2)
p1 <- p1 + scale_x_continuous(name = "Age groups (year)", minor_breaks = seq(-1, 20, 1), breaks = seq(0,20,5)) + scale_y_continuous(name = "Estimated nb at age in catch (log-scale)")
p1 <- p1 + geom_smooth(data = subset(tmp.data, Age.Group >= 4 & Age.Group <= 9), method = "lm", se = FALSE)
p1 <- p1 + theme(axis.text=element_text(size=12), axis.title=element_text(size=18,face="bold"), legend.text=element_text(size=18))
p1 <- p1 + theme(legend.title=element_text(size=18))
print(p1)

postscript(file = "../Graphics/MulletCrossSectionalAnalysis4Presentation.ps")
print(p1)
dev.off()

# Estimate Z according to cross-sectional analysis
all.years <- unique( subset(tmp.data, Age.Group >= 4 & Age.Group <= 9)$Year)
results <- data.frame(Year = all.years, Z.est = NA)

for(year in all.years){

print(year)
x <- with(subset(tmp.data, Age.Group >= 4 & Age.Group <= 9 & Year == year), Age.Group)
y <- log(with(subset(tmp.data, Age.Group >= 4 & Age.Group <= 9 & Year == year), Numbers.Harvested))
my.lm <- lm(y~x)
results[which(results$Year == year), 2] <- -coef(my.lm)[2]
}
plot(results, pch = 19, ylim = c(0, 1.4)); abline(h=2 * 0.33, col = "red", lwd = 1.5)
 
